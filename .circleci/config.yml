# build and deploy container to dockerhub
services:
  - docker

stages:
  - build
  - name: deploy
    if: branch = master

sudo: required
dist: xenial

jobs:
  build:
    install:
      - pip install --user -U pip
      - pip install --user osfclient
    steps: 
      # pull the data from public osf repo
      # note that secure environment variables are set within travis
      - run: osf fetch data/fluency/transition_probs.csv data/transition_probs.csv
      # now lets build the container
      # - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - run: make build
      # now test that it works by running the simulation
      - run: docker run adamnhornsby/fluency-model:latest python3 ./ fit all
  deploy:
    install:
      - pip install --user -U pip
      - pip install --user osfclient
    steps: 
      # pull the data from public osf repo
      # - run: pip install osfclient
      - run: osf fetch data/fluency/transition_probs.csv data/transition_probs.csv
      # build and deploy the container image to dockerhub
      - run: echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - run: make build
      - run: make deploy